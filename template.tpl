___TERMS_OF_SERVICE___

By creating or modifying this file you agree to Google Tag Manager's Community
Template Gallery Developer Terms of Service available at
https://developers.google.com/tag-manager/gallery-tos (or such other URL as
Google may provide), as modified from time to time.

___INFO___

{
  "type": "TAG",
  "id": "cvt_temp_public_id",
  "version": 1,
  "securityGroups": [],
  "displayName": "Journify tracker",
  "categories": [
    "ADVERTISING",
    "DATA_WAREHOUSING"
  ],
  "brand": {
    "id": "journifyio",
    "displayName": "Journify",
    "thumbnail": "data:image/jpeg;base64,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"
  },
  "description": "Capture and sync customer data to any marketing tool.",
  "containerContexts": [
    "WEB"
  ]
}


___TEMPLATE_PARAMETERS___

[
  {
    "type": "SELECT",
    "name": "tag_type",
    "displayName": "Tag type",
    "macrosInSelect": true,
    "selectItems": [
      {
        "value": "identify",
        "displayValue": "identify"
      },
      {
        "value": "group",
        "displayValue": "group"
      },
      {
        "value": "track",
        "displayValue": "track"
      },
      {
        "value": "page",
        "displayValue": "page"
      }
    ],
    "simpleValueType": true
  },
  {
    "type": "TEXT",
    "name": "write_key",
    "displayName": "Write Key",
    "simpleValueType": true,
    "notSetText": "Write key is required",
    "valueValidators": [
      {
        "type": "NON_EMPTY"
      }
    ]
  },
  {
    "type": "TEXT",
    "name": "user_id",
    "displayName": "User id",
    "simpleValueType": true,
    "enablingConditions": [
      {
        "paramName": "tag_type",
        "paramValue": "identify",
        "type": "EQUALS"
      }
    ],
    "notSetText": "User id is required",
    "valueValidators": [
      {
        "type": "NON_EMPTY"
      }
    ]
  },
  {
    "type": "SIMPLE_TABLE",
    "name": "user_traits",
    "displayName": "User traits (optional)",
    "simpleTableColumns": [
      {
        "defaultValue": "",
        "displayName": "Trait key",
        "name": "trait_key",
        "type": "TEXT"
      },
      {
        "defaultValue": "",
        "displayName": "Trait value",
        "name": "trait_value",
        "type": "TEXT"
      }
    ],
    "newRowButtonText": "Add Trait",
    "enablingConditions": [
      {
        "paramName": "tag_type",
        "paramValue": "identify",
        "type": "EQUALS"
      }
    ]
  },
  {
    "type": "TEXT",
    "name": "external_id_value",
    "displayName": "External id value (optional)",
    "simpleValueType": true,
    "canBeEmptyString": true,
    "enablingConditions": [
      {
        "paramName": "tag_type",
        "paramValue": "identify",
        "type": "EQUALS"
      }
    ]
  },
  {
    "type": "TEXT",
    "name": "external_id_type",
    "displayName": "External id type (optional)",
    "simpleValueType": true,
    "canBeEmptyString": true,
    "enablingConditions": [
      {
        "paramName": "tag_type",
        "paramValue": "identify",
        "type": "EQUALS"
      }
    ]
  },
  {
    "type": "TEXT",
    "name": "external_id_collection",
    "displayName": "External id collection (optional)",
    "simpleValueType": true,
    "canBeEmptyString": true,
    "enablingConditions": [
      {
        "paramName": "tag_type",
        "paramValue": "identify",
        "type": "EQUALS"
      }
    ]
  },
  {
    "type": "TEXT",
    "name": "group_id",
    "displayName": "Group id",
    "simpleValueType": true,
    "enablingConditions": [
      {
        "paramName": "tag_type",
        "paramValue": "group",
        "type": "EQUALS"
      }
    ],
    "valueValidators": [
      {
        "type": "NON_EMPTY"
      }
    ],
    "notSetText": "Group id is required"
  },
  {
    "type": "SIMPLE_TABLE",
    "name": "group_traits",
    "displayName": "Group traits (optional)",
    "simpleTableColumns": [
      {
        "defaultValue": "",
        "displayName": "Trait key",
        "name": "trait_key",
        "type": "TEXT"
      },
      {
        "defaultValue": "",
        "displayName": "Trait value",
        "name": "trait_value",
        "type": "TEXT"
      }
    ],
    "newRowButtonText": "Add Group Trait",
    "enablingConditions": [
      {
        "paramName": "tag_type",
        "paramValue": "group",
        "type": "EQUALS"
      }
    ]
  },
  {
    "type": "SIMPLE_TABLE",
    "name": "event_properties",
    "displayName": "Event properties (optional)",
    "simpleTableColumns": [
      {
        "defaultValue": "",
        "displayName": "Property key",
        "name": "property_key",
        "type": "TEXT"
      },
      {
        "defaultValue": "",
        "displayName": "Property value",
        "name": "property_value",
        "type": "TEXT"
      }
    ],
    "newRowButtonText": "Add property",
    "enablingConditions": [
      {
        "paramName": "tag_type",
        "paramValue": "track",
        "type": "EQUALS"
      }
    ]
  },
  {
    "type": "TEXT",
    "name": "page_name",
    "displayName": "Page name (optional)",
    "simpleValueType": true,
    "canBeEmptyString": true,
    "enablingConditions": [
      {
        "paramName": "tag_type",
        "paramValue": "page",
        "type": "EQUALS"
      }
    ]
  },
  {
    "type": "SIMPLE_TABLE",
    "name": "page_properties",
    "displayName": "Page Properties (optional)",
    "simpleTableColumns": [
      {
        "defaultValue": "",
        "displayName": "Property key",
        "name": "property_key",
        "type": "TEXT"
      },
      {
        "defaultValue": "",
        "displayName": "Property value",
        "name": "property_value",
        "type": "TEXT"
      }
    ],
    "newRowButtonText": "Add property",
    "enablingConditions": [
      {
        "paramName": "tag_type",
        "paramValue": "page",
        "type": "EQUALS"
      }
    ]
  },
  {
    "type": "TEXT",
    "name": "cookie_domain",
    "displayName": "Cookie domain (optional)",
    "simpleValueType": true,
    "canBeEmptyString": true
  },
  {
    "type": "TEXT",
    "name": "session_duration_min",
    "displayName": "Session duration in minutes (optional)",
    "simpleValueType": true,
    "canBeEmptyString": true
  }
]


___SANDBOXED_JS_FOR_WEB_TEMPLATE___

const injectScript = require('injectScript');
const log = require('logToConsole');
const makeNumber = require('makeNumber');
const makeTableMap = require('makeTableMap');
const copyFromWindow = require('copyFromWindow');

// constants
const VERSION = 'v0.0.83';
const JS_URL = 'https://cdn.jsdelivr.net/npm/@journifyio/js-sdk@'+VERSION+'/dist/_bundles/journifyio.min.js';
const LOG_PREFIX = '[Journify / GTM] ';
const JOURNIFY_WINDOW_KEY = 'journify';

// helpers

const fail = msg => {
    log(LOG_PREFIX + 'Error: ' + msg);
    return data.gtmOnFailure();
};

const onsuccess = () => {
    const journify = copyFromWindow(JOURNIFY_WINDOW_KEY);
    if (!journify) {
        return fail('Failed to load the window.journify');
    }

    load(journify);

    switch (data.tag_type) {
        case 'identify':
            identify(journify);
            break;
        case 'group':
            group(journify);
            break;
        case 'track':
            track(journify);
            break;
        case 'page':
            page(journify);
            break;
    }

    data.gtmOnSuccess();
};

const load = (journify) => {
    if (!dataHasField("write_key")) {
        return fail('`write_key` setting is required when calling `load`');
    }

    const settings = {
        writeKey: data.write_key,
    };

    if (dataHasField("cookie_domain")) {
        settings.cookie = {
            domain: data.cookie_domain,
        };
    }

    if (dataHasField("session_duration_min")){
        const sessionDurationMin = makeNumber(data.session_duration_min);
        if (typeof sessionDurationMin !== "undefined") {
            settings.sessionDurationMin = sessionDurationMin;
        }
    }

    journify.load(settings);
    log(LOG_PREFIX + 'Success: loading Journify SDK');
};

const identify = (journify) => {
    if (!dataHasField("user_id")) {
        return fail('`user_id` setting is required when calling `identify`');
    }

    let traits = null;
    if (dataHasField("user_traits")) {
        traits = makeTableMap(data.user_traits || [], 'trait_key', 'trait_value');
    }

    let externalId = null;
    if (dataHasField("external_id_value")) {
        externalId = {
            externalId: data.external_id_value,
            type: data.external_id_type,
            collection: data.external_id_collection,
        };
    }

    journify.identify(data.user_id, traits,  externalId)
        .then((ctx) => log(LOG_PREFIX + 'Success: Journify Identify call, context', ctx))
        .catch((e) => fail(e));
};

const group = (journify) => {
    if (!dataHasField("group_id")) {
        return fail('`group_id` setting is required when calling `group`');
    }

    let traits = null;
    if (dataHasField("group_traits")) {
        traits = makeTableMap(data.group_traits || [], 'trait_key', 'trait_value');
    }

    journify.group(data.group_id, traits)
        .then((ctx) => log(LOG_PREFIX + 'Success: Journify Group call, context', ctx))
        .catch((e) => fail(e));
};

const track = (journify) => {
    let properties = null;
    if (dataHasField("event_properties")) {
        properties = makeTableMap(data.event_properties || [], 'property_key', 'property_value');
    }

    journify.track(data.event, properties)
        .then((ctx) => log(LOG_PREFIX + 'Success: Journify Track call, context', ctx))
        .catch((e) => fail(e));
};

const page = (journify) => {
    let pageName = null;
    if (dataHasField("page_name")) {
        pageName = data.page_name;
    }

    let properties = null;
    if (dataHasField("page_properties")) {
        properties = makeTableMap(data.page_properties || [], 'property_key', 'property_value');
    }

    journify.page(pageName, properties)
        .then((ctx) => log(LOG_PREFIX + 'Success: Journify Page call, context', ctx))
        .catch((e) => fail(e));
};

const dataHasField = (fieldKey) => {
    const val = data[fieldKey];
    return val && val.length > 0;
};

const onfailure = () => {
    return fail('Failed to load the Journify JavaScript library');
};


injectScript(JS_URL, onsuccess, onfailure, 'journify');


___WEB_PERMISSIONS___

[
  {
    "instance": {
      "key": {
        "publicId": "logging",
        "versionId": "1"
      },
      "param": [
        {
          "key": "environments",
          "value": {
            "type": 1,
            "string": "debug"
          }
        }
      ]
    },
    "clientAnnotations": {
      "isEditedByUser": true
    },
    "isRequired": true
  },
  {
    "instance": {
      "key": {
        "publicId": "access_globals",
        "versionId": "1"
      },
      "param": [
        {
          "key": "keys",
          "value": {
            "type": 2,
            "listItem": [
              {
                "type": 3,
                "mapKey": [
                  {
                    "type": 1,
                    "string": "key"
                  },
                  {
                    "type": 1,
                    "string": "read"
                  },
                  {
                    "type": 1,
                    "string": "write"
                  },
                  {
                    "type": 1,
                    "string": "execute"
                  }
                ],
                "mapValue": [
                  {
                    "type": 1,
                    "string": "journify"
                  },
                  {
                    "type": 8,
                    "boolean": true
                  },
                  {
                    "type": 8,
                    "boolean": true
                  },
                  {
                    "type": 8,
                    "boolean": true
                  }
                ]
              }
            ]
          }
        }
      ]
    },
    "clientAnnotations": {
      "isEditedByUser": true
    },
    "isRequired": true
  },
  {
    "instance": {
      "key": {
        "publicId": "inject_script",
        "versionId": "1"
      },
      "param": [
        {
          "key": "urls",
          "value": {
            "type": 2,
            "listItem": [
              {
                "type": 1,
                "string": "https://cdn.jsdelivr.net/npm/@journifyio/js-sdk@*"
              }
            ]
          }
        }
      ]
    },
    "clientAnnotations": {
      "isEditedByUser": true
    },
    "isRequired": true
  }
]


___TESTS___

scenarios: []


___NOTES___

Created on 3/28/2023, 1:47:47 PM


